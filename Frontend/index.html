<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <title>Preventa y boleta</title>
</head>
<body>
    <h1>Ferremás</h1>
    <div class="container mt-4">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Boleta</h3>
            </div>
            <div class="card-body">
                <form id="boletaForm">
                    <!-- Cliente -->
                    <div class="mb-3">
                        <label for="cboCliente" class="form-label">Cliente:</label>
                        <select name="cboCliente" id="cboCliente" class="form-select"></select>
                    </div>
                    
                    <!-- Productos -->
                    <div id="productosContainer">
                        <div class="producto mb-3">
                            <div class="row">
                                <div class="col">
                                    <label for="cboProducto" class="form-label">Producto:</label>
                                    <select name="cboProducto" class="form-select cboProducto"></select>
                                </div>
                                <div class="col">
                                    <label for="txtCantidad" class="form-label">Cantidad:</label>
                                    <input type="number" name="txtCantidad" class="form-control txtCantidad">
                                </div>
                                <div class="col">
                                    <label for="txtPrecio" class="form-label">Precio:</label>
                                    <input type="text" name="txtPrecio" class="form-control txtPrecio" readonly>
                                </div>
                                <div class="col">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="button" class="btn btn-danger btnRemoveProducto">Eliminar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" id="addProductoBtn" class="btn btn-secondary">Agregar Producto</button>
                    
                    <!-- Despacho -->
                    <div class="mb-3 form-check">
                        <ul>
                            <li>
                                <label for="opc1">Despacho a domicilio</label>
                                <input type="radio" id="opc1" name="entrega" />
                            </li>
                            <li>
                                <label for="opc2">Retiro en tienda</label>
                                <input type="radio" id="opc2" name="entrega" checked />
                            </li>
                        </ul>
                    </div>

                    <div class="mb-3">
                        <label for="txtTotal" class="form-label">Total:</label>
                        <input type="text" id="txtTotal" class="form-control" readonly>
                    </div>

                    <button id="btnEnviar" class="btn btn-primary">Finalizar compra</button>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script>
        const cboCliente = document.getElementById('cboCliente');
        const productosContainer = document.getElementById('productosContainer');
        const txtTotal = document.getElementById('txtTotal');

        // Obtener clientes
        fetch("http://localhost:5000/api/cliente", {
            headers: {
                "Content-Type": "application/json",
                "Access-Control-Allow-Origin": "*",
            },
            mode: 'cors'
        })
        .then(response => response.json())
        .then(clientes => {
            let options = "";
            clientes.forEach(cliente => {
                options += `<option value="${cliente.id}">${cliente.nombre}</option>`;
            });
            cboCliente.innerHTML = options;
        })
        .catch(error => console.error('Error al obtener los datos del cliente:', error));

        // Obtener productos
        let productos = [];
        fetch("http://localhost:5000/api/producto", {
            headers: {
                "Content-Type": "application/json",
                "Access-Control-Allow-Origin": "*",
            },
            mode: 'cors'
        })
        .then(response => response.json())
        .then(data => {
            productos = data;
            actualizarSelectsProductos();
        })
        .catch(error => console.error('Error al obtener los datos del producto:', error));

        function actualizarSelectsProductos() {
            const options = productos.map(producto => 
                `<option value="${producto.id}" data-precio="${producto.precio}">${producto.nombre}</option>`
            ).join('');
            document.querySelectorAll('.cboProducto').forEach(select => {
                select.innerHTML = options;
            });
        }

        // Agregar producto dinámicamente
        document.getElementById('addProductoBtn').addEventListener('click', function() {
            const productoTemplate = `
                <div class="producto mb-3">
                    <div class="row">
                        <div class="col">
                            <label for="cboProducto" class="form-label">Producto:</label>
                            <select name="cboProducto" class="form-select cboProducto"></select>
                        </div>
                        <div class="col">
                            <label for="txtCantidad" class="form-label">Cantidad:</label>
                            <input type="number" name="txtCantidad" class="form-control txtCantidad">
                        </div>
                        <div class="col">
                            <label for="txtPrecio" class="form-label">Precio:</label>
                            <input type="text" name="txtPrecio" class="form-control txtPrecio" readonly>
                        </div>
                        <div class="col">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-danger btnRemoveProducto">Eliminar</button>
                        </div>
                    </div>
                </div>
            `;
            productosContainer.insertAdjacentHTML('beforeend', productoTemplate);
            actualizarSelectsProductos();
            actualizarEventosProductos();
            actualizarTotal();
        });

        function actualizarEventosProductos() {
            document.querySelectorAll('.cboProducto').forEach(select => {
                select.addEventListener('change', function() {
                    const precioInput = select.parentElement.parentElement.querySelector('.txtPrecio');
                    const selectedOption = select.options[select.selectedIndex];
                    precioInput.value = parseFloat(selectedOption.getAttribute('data-precio')) || 0;
                    actualizarTotal();
                });
            });

            document.querySelectorAll('.txtCantidad').forEach(input => {
                input.addEventListener('input', function() {
                    actualizarTotal();
                });
            });

            document.querySelectorAll('.btnRemoveProducto').forEach(button => {
                button.addEventListener('click', function() {
                    button.closest('.producto').remove();
                    actualizarTotal();
                });
            });
        }

        function actualizarTotal() {
        let total = 0;
        document.querySelectorAll('.producto').forEach(productoDiv => {
            const cantidad = parseFloat(productoDiv.querySelector('.txtCantidad').value) || 0;
            const precio = parseFloat(productoDiv.querySelector('.txtPrecio').value) || 0;
            total += cantidad * precio;
        });
        txtTotal.value = parseFloat(total.toFixed(2)).toString(); // Convertir a número y quitar ceros innecesarios
        }


        actualizarEventosProductos();

        // Manejar el envío del formulario
        document.getElementById('btnEnviar').addEventListener('click', function(e) {
            e.preventDefault();

            const idCliente = cboCliente.value;
            const productos = [];
            document.querySelectorAll('.producto').forEach(productoDiv => {
                const idProducto = productoDiv.querySelector('.cboProducto').value;
                const cantidad = productoDiv.querySelector('.txtCantidad').value;
                const precio = productoDiv.querySelector('.txtPrecio').value;
                productos.push({ idProducto, cantidad, precio });
            });

            const despacho = document.querySelector('input[name="entrega"]:checked').id === 'opc1';

            const objEnvio = {
                idCliente,
                productos,
                despachoDomicilio: despacho
            };
            console.log(objEnvio);

            // Aquí se realizaría la petición POST a la API para enviar la boleta
            fetch("http://localhost:5002/api/boleta/", {
                headers: {
                    "Content-Type": "application/json",
                    "Access-Control-Allow-Origin": "*",
                },
                mode: 'cors',
                method: 'POST',
                body: JSON.stringify(objEnvio)
            })
            .then(response => response.json())
            .then(data => console.log('Respuesta de la API:', data))
            .catch(error => console.error('Error al enviar la boleta:', error))
            .finally(() => alert('Boleta enviada correctamente'));
        });
    </script>
</body>
</html>
